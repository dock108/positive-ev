<!-- Parlay Analysis Popup -->
<div id="parlayPopup" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Parlay Analysis (Beta)</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Loading State -->
            <div id="loadingState" class="hidden">
                <div class="flex items-center justify-center p-6">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <span class="ml-2 text-gray-600">Loading bets...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden">
                <div class="text-red-600 bg-red-50 p-4 rounded-lg border border-red-200 mb-4">
                    <p class="flex items-center">
                        <span class="mr-2">⚠️</span>
                        <span id="errorMessage">Error loading bets. Please try again.</span>
                    </p>
                    <button onclick="retryLoadBets()" class="mt-2 text-sm text-red-700 hover:text-red-800 underline">
                        Retry
                    </button>
                </div>
            </div>
            
            <!-- Sportsbook Display -->
            <div id="sportsbook-display" class="mb-4 text-lg font-semibold text-gray-800">
                <span id="sportsbook-name"></span> Parlay Options
            </div>
            
            <div class="bet-list">
                <div class="flex items-center justify-between cursor-pointer" id="availableBetsHeader" onclick="toggleAvailableBets()">
                    <h3 class="text-lg font-medium">Available Bets</h3>
                    <span id="availableBetsToggle" class="text-gray-500">▼</span>
                </div>
                <div id="availableBets" class="mt-2">
                    <!-- Bets will be populated here -->
                </div>
            </div>
            
            <div class="parlay-results" style="display: none;">
                <h3>Parlay Analysis Results</h3>
                
                <!-- Grade Display -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-gray-100 rounded-full w-16 h-16 flex flex-col items-center justify-center">
                        <div id="parlayGrade" class="text-lg font-semibold text-gray-800"></div>
                        <div class="text-xs text-gray-500">Grade</div>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>EV: <span id="gradeEv" class="font-medium"></span></div>
                        <div>Edge: <span id="gradeEdge" class="font-medium"></span></div>
                        <div>Win Prob: <span id="gradeWinProb" class="font-medium"></span></div>
                    </div>
                </div>
                
                <!-- Odds Comparison -->
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold mb-2">Parlay Odds</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600 group relative cursor-help">
                                Calculated True Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Our calculated fair odds based on true probabilities of each leg
                                </span>
                            </label>
                            <div id="parlayOdds" class="text-lg font-bold text-blue-700"></div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 group relative cursor-help">
                                Estimated Market Odds
                                <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                                    Expected sportsbook odds based on current market prices
                                </span>
                            </label>
                            <div id="theoreticalOdds" class="text-lg font-bold text-blue-700"></div>
                        </div>
                    </div>
                    <p class="mt-3 text-sm text-blue-800 bg-blue-100 p-2 rounded">
                        ⚠️ Verify your sportsbook offers odds greater than our calculated true odds before placing the bet
                    </p>
                </div>

                <!-- Bet Sizing -->
                <div class="p-4 bg-yellow-50 rounded-lg mb-4">
                    <h4 class="font-semibold mb-2 group relative cursor-help">
                        Recommended Bet Size
                        <span class="tooltip invisible group-hover:visible absolute left-0 top-6 w-48 p-2 bg-gray-900 text-white text-xs rounded shadow-lg z-10">
                            Suggested bet amount based on Kelly criterion and parlay risk factors
                        </span>
                    </h4>
                    <div id="parlayBetSize" class="text-2xl font-bold text-yellow-700 text-center"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="flex flex-col items-center space-y-4">
                <button id="calculateParlay" class="btn btn-primary" disabled>Calculate Parlay</button>
                <div class="p-4 bg-amber-50 rounded-lg border border-amber-200 text-center w-full">
                    <h4 class="font-semibold mb-2 text-amber-800">Beta Feature</h4>
                    <div class="text-sm text-amber-700">
                        <p>Not all bets may be parlay-able with your sportsbook.</p>
                        <p id="correlationWarning" class="mt-2" style="display: none;">Some of these bets may be correlated, affecting calculation accuracy.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 800px;
    border-radius: 8px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.bet-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.bet-item {
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: white;
    transition: background-color 0.2s;
}

.bet-item:hover {
    background-color: #f5f5f5;
}

.bet-item.selected {
    background-color: #e8f0fe;
    border-color: #4285f4;
}

.result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.result-item {
    background-color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.result-item label {
    display: block;
    font-weight: 500;
    color: #4a5568;
    margin-bottom: 0.5rem;
}

.result-item span {
    font-size: 1.125rem;
    color: #2d3748;
}

.warning {
    background-color: #fff3cd;
    color: #856404;
    padding: 12px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #ffeeba;
}

.btn {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #4285f4;
    color: white;
    border: none;
}

.btn-primary:hover:not(:disabled) {
    background-color: #3367d6;
}

.btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.modal-footer {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: right;
}

.beta-warning {
    margin-bottom: 1rem;
}

.hidden {
    display: none;
}

.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.metric-better {
    color: #047857;  /* green-700 */
}

.metric-worse {
    color: #dc2626;  /* red-600 */
}

#availableBetsHeader {
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: background-color 0.2s;
}

#availableBetsHeader:hover {
    background-color: #f3f4f6;
}

#sportsbook-display {
    padding: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 1rem;
}

.tooltip {
    pointer-events: none;
}

.group:hover .tooltip {
    display: block;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('parlayPopup');
    const closeBtn = popup.querySelector('.close');
    const calculateBtn = document.getElementById('calculateParlay');
    const betsList = document.getElementById('availableBets');
    const parlayResults = document.querySelector('.parlay-results');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    
    let selectedBets = new Set();
    let currentSportsbook = null;
    
    // Close popup
    closeBtn.onclick = function() {
        popup.style.display = 'none';
        parlayResults.style.display = 'none';
        errorState.classList.add('hidden');
    }
    
    window.onclick = function(event) {
        if (event.target == popup) {
            popup.style.display = 'none';
            parlayResults.style.display = 'none';
            errorState.classList.add('hidden');
        }
    }
    
    // Add function to toggle available bets
    window.toggleAvailableBets = function() {
        const betsList = document.getElementById('availableBets');
        const toggle = document.getElementById('availableBetsToggle');
        if (betsList.style.display === 'none') {
            betsList.style.display = 'block';
            toggle.textContent = '▼';
        } else {
            betsList.style.display = 'none';
            toggle.textContent = '▶';
        }
    }
    
    // Load bets for a sportsbook
    window.loadParlayBets = async function(sportsbook) {
        currentSportsbook = sportsbook;
        try {
            // Show loading state
            popup.style.display = 'block';
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            betsList.innerHTML = '';
            selectedBets.clear();
            calculateBtn.disabled = true;
            parlayResults.style.display = 'none';
            
            // Update sportsbook display
            document.getElementById('sportsbook-name').textContent = sportsbook;
            
            const response = await fetch(`/api/sportsbook_bets/${sportsbook}`);
            const data = await response.json();
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (!data.length) {
                throw new Error('No eligible bets found for parlay.');
            }
            
            // Show available bets expanded initially
            document.getElementById('availableBets').style.display = 'block';
            document.getElementById('availableBetsToggle').textContent = '▼';
            
            data.forEach(bet => {
                const betDiv = document.createElement('div');
                betDiv.className = 'bet-item';
                betDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="bet_${bet.bet_id}" data-bet-id="${bet.bet_id}" class="h-4 w-4">
                        <div>
                            <label for="bet_${bet.bet_id}" class="font-medium">${bet.description}</label>
                            <div class="text-sm text-gray-500">
                                <span class="font-medium ${bet.grade === 'A' ? 'text-green-600' : bet.grade === 'B' ? 'text-blue-600' : 'text-purple-600'}">
                                    Grade ${bet.grade}
                                </span>
                                • Odds: ${bet.odds > 0 ? '+' + bet.odds : bet.odds}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">EV: ${bet.ev_percent.toFixed(2)}%</div>
                        <div class="text-sm text-gray-500">Edge: ${bet.edge ? bet.edge.toFixed(2) + '%' : 'N/A'}</div>
                    </div>
                `;
                
                const checkbox = betDiv.querySelector('input');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedBets.add(bet.bet_id);
                        betDiv.classList.add('selected');
                    } else {
                        selectedBets.delete(bet.bet_id);
                        betDiv.classList.remove('selected');
                    }
                    calculateBtn.disabled = selectedBets.size < 2;
                    
                    // Hide results when selection changes
                    parlayResults.style.display = 'none';
                });
                
                betsList.appendChild(betDiv);
            });
            
        } catch (error) {
            console.error('Error loading bets:', error);
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            errorMessage.textContent = error.message || 'Error loading bets. Please try again.';
        }
    }
    
    // Retry loading bets
    window.retryLoadBets = function() {
        if (currentSportsbook) {
            loadParlayBets(currentSportsbook);
        }
    }
    
    // Calculate parlay
    calculateBtn.onclick = async function() {
        try {
            loadingState.classList.remove('hidden');
            parlayResults.style.display = 'none';
            errorState.classList.add('hidden');
            
            // Collapse available bets after calculation
            document.getElementById('availableBets').style.display = 'none';
            document.getElementById('availableBetsToggle').textContent = '▶';
            
            const response = await fetch('/api/calculate_parlay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bet_ids: Array.from(selectedBets)
                })
            });
            
            loadingState.classList.add('hidden');
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            // Debug logging
            console.log('Parlay calculation result:', {
                parlay_metrics: result.parlay_metrics,
                comparison: result.comparison,
                ev_percent: result.parlay_metrics?.ev_percent,
                true_probability: result.parlay_metrics?.true_probability
            });
            
            // Helper function to safely format numbers
            const formatNumber = (value, decimals = 2) => {
                if (value === undefined || value === null || isNaN(value)) return '0.00';
                return Number(value).toFixed(decimals);
            };
            
            // Update grade display with proper styling
            const gradeDiv = document.getElementById('parlayGrade');
            const grade = result.parlay_metrics?.grade || 'F';
            gradeDiv.textContent = grade;
            gradeDiv.className = `text-lg font-semibold ${
                grade === 'A' ? 'text-green-600' :
                grade === 'B' ? 'text-blue-600' :
                grade === 'C' ? 'text-purple-600' :
                grade === 'D' ? 'text-red-600' :
                'text-gray-600'
            }`;

            // Update grade metrics
            document.getElementById('gradeEv').textContent = 
                `${formatNumber(result.parlay_metrics?.ev_percent)}%`;
            document.getElementById('gradeEdge').textContent = 
                `${formatNumber(result.parlay_metrics?.edge_percent || result.comparison?.edge_percent)}%`;
            document.getElementById('gradeWinProb').textContent = 
                `${formatNumber(result.parlay_metrics?.true_probability * 100)}%`;
            
            // Update odds comparison
            document.getElementById('parlayOdds').textContent = result.parlay_metrics?.american_odds > 0 ? 
                `+${formatNumber(result.parlay_metrics.american_odds, 0)}` : 
                formatNumber(result.parlay_metrics.american_odds, 0);
            
            document.getElementById('theoreticalOdds').textContent = result.comparison?.theoretical_combined_odds > 0 ?
                `+${formatNumber(result.comparison.theoretical_combined_odds, 0)}` : 
                formatNumber(result.comparison.theoretical_combined_odds, 0);
            
            // Update bet sizing with proper value access
            document.getElementById('parlayBetSize').textContent = 
                `$${formatNumber(result.comparison?.recommended_parlay_size, 0)}`;
            
            // Show/hide correlation warning in beta notice
            const correlationWarning = document.getElementById('correlationWarning');
            correlationWarning.style.display = result.parlay_metrics?.correlated_warning ? 'block' : 'none';
            
            parlayResults.style.display = 'block';
        } catch (error) {
            console.error('Error calculating parlay:', error);
            errorState.classList.remove('hidden');
            errorMessage.textContent = error.message || 'Error calculating parlay. Please try again.';
        }
    }
});
</script> 